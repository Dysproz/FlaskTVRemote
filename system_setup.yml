---

- hosts: localhost
  become: yes
  tasks:
  - name: Install python, pip, git and supervisor
    apt:
      pkg: "{{ item }}"
      state: latest
      update_cache: true
    with_items:
      - python
      - python3
      - python-pip
      - git
      - supervisor

  - name: Install flask and wtforms
    pip:
      name: "{{ item }}"
    with_items:
      - flask
      - wtforms
  - name: Install chrome
    block:
    - name: Check for chrome
      command: test -f /etc/apt/sources.list.d/google-chrome.list
      register: google_apt_exists
      ignore_errors: True

   
    - name: "apt | ensure Google linux signing key present"
      apt_key: url=https://dl-ssl.google.com/linux/linux_signing_key.pub state=present
      when: google_apt_exists.rc == 1

    
    - name: "apt | ensure Google chrome repo present"
      apt_repository:
        repo: "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main"
        filename: "google-chrome"
        state: present
        update_cache: yes
    
    - name: Update apt cache
      apt: update_cache=true
      when: google_apt_exists.rc == 1

    - name: Install chrome
      apt:
        pkg: google-chrome-stable
        state: installed
        
  - name: Pull files
    git:
      repo: 'https://github.com/Dysproz/FlaskTVRemote.git'
      dest: /usr/local/teleserver

  - name: Configure teleserver to autostart
    block:
    - name: Copy configuration file to supervisor
      copy:
        src: /usr/local/teleserver/teleserver.conf
        dest: /etc/supervisor/conf.d/teleserver.conf
        
    - name: Reread supervisor
      command: supervisorctl reread

    - name: Update supervisor
      command: supervisorctl update

  - name: Reboot
    command: reboot
  

        